{% extends "base.html" %} {% block title %}Convert Video{% endblock %}

{% block content %}
<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <h3 class="loading-title">Converting Video</h3>
        <p class="loading-status" id="loadingStatus">Initializing...</p>
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <p class="progress-text" id="progressText">0%</p>
        <p class="loading-tip">Please wait, this may take a few minutes...</p>
    </div>
</div>

<div class="row justify-content-center" style="margin-top: 3rem;">
    <div class="col-lg-8 col-md-10">
        <div class="card">
            <div class="card-header text-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" class="bi bi-youtube" viewBox="0 0 16 16" style="margin-right: 10px;">
                    <path d="M8.051 1.999h.089c.822.003 4.987.033 6.11.335a2.01 2.01 0 0 1 1.415 1.42c.101.38.172.883.22 1.402l.01.104.022.26.008.104c.065.914.073 1.77.074 1.957v.075c-.001.194-.01 1.108-.082 2.06l-.008.105-.009.104c-.05.572-.124 1.14-.235 1.558a2.007 2.007 0 0 1-1.415 1.42c-1.16.312-5.569.334-6.18.335h-.142c-.309 0-1.587-.006-2.927-.052l-.17-.006-.087-.004-.171-.007-.171-.007c-1.11-.049-2.167-.128-2.654-.26a2.007 2.007 0 0 1-1.415-1.419c-.111-.417-.185-.986-.235-1.558L.09 9.82l-.008-.104A31.4 31.4 0 0 1 0 7.68v-.123c.002-.215.01-.958.064-1.778l.007-.103.003-.052.008-.104.022-.26.01-.104c.048-.519.119-1.023.22-1.402a2.007 2.007 0 0 1 1.415-1.42c.487-.13 1.544-.21 2.654-.26l.17-.007.172-.006.086-.003.171-.007A99.788 99.788 0 0 1 7.858 2h.193zM6.4 5.209v4.818l4.157-2.408L6.4 5.209z"/>
                </svg>
                Video Converter
            </div>
            <div class="card-body">
                <h2 class="page-title">Download YouTube Videos</h2>
                <p class="page-subtitle">Convert any YouTube video to MP3 or MP4 format</p>
                
                <form method="POST" id="convertForm">
                    <div class="form-group">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <div class="input-group-text">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-link-45deg" viewBox="0 0 16 16">
                                        <path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"/>
                                        <path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"/>
                                    </svg>
                                </div>
                            </div>
                            <input
                                type="url"
                                class="form-control"
                                id="url" name="url"
                                placeholder="Paste YouTube video URL here..."
                                value="{{ url }}"
                                required>
                        </div>
                    </div>
                    
                    <div class="text-center" style="margin-top: 2rem;">
                        <button type="submit" class="btn btn-primary btn-lg mr-3" name="convert" value="mp4" onclick="showLoading('MP4')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-film" viewBox="0 0 16 16" style="margin-right: 8px;">
                                <path d="M0 1a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1V1zm4 0v6h8V1H4zm8 8H4v6h8V9zM1 1v2h2V1H1zm2 3H1v2h2V4zM1 7v2h2V7H1zm2 3H1v2h2v-2zm-2 3v2h2v-2H1zM15 1h-2v2h2V1zm-2 3v2h2V4h-2zm2 3h-2v2h2V7zm-2 3v2h2v-2h-2zm2 3h-2v2h2v-2z"/>
                            </svg>
                            MP4 Video
                        </button>
                        <button type="submit" class="btn btn-primary btn-lg" name="convert" value="mp3" onclick="showLoading('MP3')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-music-note-beamed" viewBox="0 0 16 16" style="margin-right: 8px;">
                                <path d="M6 13c0 1.105-1.12 2-2.5 2S1 14.105 1 13c0-1.104 1.12-2 2.5-2s2.5.896 2.5 2zm9-2c0 1.105-1.12 2-2.5 2s-2.5-.895-2.5-2 1.12-2 2.5-2 2.5.895 2.5 2z"/>
                                <path fill-rule="evenodd" d="M14 11V2h1v9h-1zM6 3v10H5V3h1z"/>
                                <path d="M5 2.905a1 1 0 0 1 .9-.995l8-.8a1 1 0 0 1 1.1.995V3L5 4V2.905z"/>
                            </svg>
                            MP3 Audio
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
let progressInterval;
let currentProgress = 0;

function showLoading(format) {
    const url = document.getElementById('url').value;
    if (!url) return;
    
    document.getElementById('loadingOverlay').style.display = 'flex';
    document.getElementById('loadingStatus').textContent = 'Fetching video information...';
    document.getElementById('progressBar').style.width = '0%';
    document.getElementById('progressText').textContent = '0%';
    currentProgress = 0;
    
    // Simulate progress stages
    const stages = [
        { progress: 15, status: 'Fetching video information...', duration: 2000 },
        { progress: 35, status: 'Downloading video stream...', duration: 4000 },
        { progress: 55, status: 'Downloading audio stream...', duration: 3000 },
        { progress: 75, status: 'Merging streams...', duration: 3000 },
        { progress: 90, status: 'Converting to ' + format + '...', duration: 5000 },
        { progress: 95, status: 'Finalizing...', duration: 2000 }
    ];
    
    let stageIndex = 0;
    
    function updateProgress() {
        if (stageIndex < stages.length) {
            const stage = stages[stageIndex];
            animateProgress(currentProgress, stage.progress, 1000);
            document.getElementById('loadingStatus').textContent = stage.status;
            currentProgress = stage.progress;
            stageIndex++;
            setTimeout(updateProgress, stage.duration);
        }
    }
    
    updateProgress();
}

function animateProgress(from, to, duration) {
    const startTime = performance.now();
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    
    function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const currentValue = from + (to - from) * easeOutCubic(progress);
        
        progressBar.style.width = currentValue + '%';
        progressText.textContent = Math.round(currentValue) + '%';
        
        if (progress < 1) {
            requestAnimationFrame(update);
        }
    }
    
    requestAnimationFrame(update);
}

function easeOutCubic(t) {
    return 1 - Math.pow(1 - t, 3);
}
</script>
{% endblock %}
